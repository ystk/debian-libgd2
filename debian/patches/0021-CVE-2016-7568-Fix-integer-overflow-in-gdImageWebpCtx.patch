From: trylab <trylab@users.noreply.github.com>
Date: Tue, 6 Sep 2016 18:35:32 +0800
Subject: [CVE-2016-7568]: Fix integer overflow in gdImageWebpCtx

Integer overflow can be happened in expression gdImageSX(im) * 4 *
gdImageSY(im). It could lead to heap buffer overflow in the following
code. This issue has been reported to the PHP Bug Tracking System. The
proof-of-concept file will be supplied some days later. This issue was
discovered by Ke Liu of Tencent's Xuanwu LAB.
---
 src/gd_webp.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/gd_webp.c b/src/gd_webp.c
index fae3861..c500b0c 100644
--- a/src/gd_webp.c
+++ b/src/gd_webp.c
@@ -166,6 +166,18 @@ int mapQualityToVP8QP(int quality) {
  */
 BGD_DECLARE(void) gdImageWebpCtx (gdImagePtr im, gdIOCtx * outfile, int quantization)
 {
+	if (im == NULL) {
+		return;
+	}
+
+	if (overflow2(gdImageSX(im), 4)) {
+		return;
+	}
+
+	if (overflow2(gdImageSX(im) * 4, gdImageSY(im))) {
+		return;
+	}
+	
 	int width = im->sx;
 	int height = im->sy;
 
