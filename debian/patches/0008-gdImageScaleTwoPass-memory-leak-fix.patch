From: Vladimir Mitrovic <vladimir.x.mitrovic@gmail.com>
Date: Wed, 5 Aug 2015 03:01:06 +0200
Subject: gdImageScaleTwoPass memory leak fix

Fixing memory leak in gdImageScaleTwoPass, as reported by @cmb69 and
confirmed by @vapier.  This bug actually bit me in production and I'm
very thankful that it was reported with an easy fix.

Fixes #173.
---
 src/gd_interpolation.c | 25 ++++---------------------
 1 file changed, 4 insertions(+), 21 deletions(-)

diff --git a/src/gd_interpolation.c b/src/gd_interpolation.c
index 88dca85..a35cb4c 100644
--- a/src/gd_interpolation.c
+++ b/src/gd_interpolation.c
@@ -1083,32 +1083,15 @@ gdImagePtr gdImageScaleTwoPass(const gdImagePtr src, const unsigned int src_widt
 	if (tmp_im == NULL) {
 		return NULL;
 	}
-	_gdScaleHoriz(src, src_width, src_height, tmp_im, new_width, src_height);
 
 	dst = gdImageCreateTrueColor(new_width, new_height);
-	if (dst == NULL) {
-		gdFree(tmp_im);
-		return NULL;
-	}
-	_gdScaleVert(tmp_im, new_width, src_height, dst, new_width, new_height);
-	gdFree(tmp_im);
-
-	return dst;
-}
-
-gdImagePtr Scale(const gdImagePtr src, const unsigned int src_width, const unsigned int src_height, const gdImagePtr dst, const unsigned int new_width, const unsigned int new_height)
-{
-	gdImagePtr tmp_im;
-
-	tmp_im = gdImageCreateTrueColor(new_width, src_height);
-	if (tmp_im == NULL) {
-		return NULL;
+	if (dst != NULL) {
+		_gdScaleHoriz(src, src_width, src_height, tmp_im, new_width, src_height);
+		_gdScaleVert(tmp_im, new_width, src_height, dst, new_width, new_height);
 	}
-	_gdScaleHoriz(src, src_width, src_height, tmp_im, new_width, src_height);
 
-	_gdScaleVert(tmp_im, new_width, src_height, dst, new_width, new_height);
+	gdImageDestroy(tmp_im);
 
-	gdFree(tmp_im);
 	return dst;
 }
 
