From a93eac0e843148dc2d631c3ba80af17e9c8c860f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?F=C3=A1bio=20Cabral=20Pacheco?= <fcabralpacheco@gmail.com>
Date: Fri, 20 Dec 2019 12:03:33 -0300
Subject: [PATCH] Fix potential NULL pointer dereference in gdImageClone()

---
 src/gd.c                          |  9 +--------
 tests/gdimageclone/.gitignore     |  1 +
 tests/gdimageclone/CMakeLists.txt |  1 +
 tests/gdimageclone/Makemodule.am  |  3 ++-
 tests/gdimageclone/style.c        | 30 ++++++++++++++++++++++++++++++
 5 files changed, 35 insertions(+), 9 deletions(-)
 create mode 100644 tests/gdimageclone/style.c

--- libgd2-jessie.git.orig/src/gd.c
+++ libgd2-jessie.git/src/gd.c
@@ -2315,14 +2315,6 @@
 		}
 	}
 
-	if (src->styleLength > 0) {
-		dst->styleLength = src->styleLength;
-		dst->stylePos    = src->stylePos;
-		for (i = 0; i < src->styleLength; i++) {
-			dst->style[i] = src->style[i];
-		}
-	}
-
 	dst->interlace   = src->interlace;
 
 	dst->alphaBlendingFlag = src->alphaBlendingFlag;
@@ -2357,6 +2349,7 @@
 
 	if (src->style) {
 		gdImageSetStyle(dst, src->style, src->styleLength);
+		dst->stylePos = src->stylePos;
 	}
 
 	for (i = 0; i < gdMaxColors; i++) {
--- /dev/null
+++ libgd2-jessie.git/tests/gdimageclone/style.c
@@ -0,0 +1,30 @@
+/**
+ * Cloning an image should exactly reproduce all style related data
+ */
+
+
+#include <string.h>
+#include "gd.h"
+#include "gdtest.h"
+
+
+int main()
+{
+    gdImagePtr im, clone;
+    int style[] = {0, 0, 0};
+
+    im = gdImageCreate(8, 8);
+    gdImageSetStyle(im, style, sizeof(style)/sizeof(style[0]));
+
+    clone = gdImageClone(im);
+    gdTestAssert(clone != NULL);
+
+    gdTestAssert(clone->styleLength == im->styleLength);
+    gdTestAssert(clone->stylePos == im->stylePos);
+    gdTestAssert(!memcmp(clone->style, im->style, sizeof(style)/sizeof(style[0])));
+
+    gdImageDestroy(clone);
+    gdImageDestroy(im);
+
+    return gdNumFailures();
+}
--- /dev/null
+++ libgd2-jessie.git/tests/gdimageclone/CMakeLists.txt
@@ -0,0 +1,5 @@
+LIST(APPEND TESTS_FILES
+	style
+)
+
+ADD_GD_TESTS()
--- /dev/null
+++ libgd2-jessie.git/tests/gdimageclone/Makemodule.am
@@ -0,0 +1,5 @@
+libgd_test_programs += \
+	gdimageclone/style
+
+EXTRA_DIST += \
+	gdimageclone/CMakeLists.txt
--- /dev/null
+++ libgd2-jessie.git/tests/gdimageclone/.gitignore
@@ -0,0 +1 @@
+/style
--- libgd2-jessie.git.orig/tests/CMakeLists.txt
+++ libgd2-jessie.git/tests/CMakeLists.txt
@@ -23,6 +23,7 @@
 		gd
 		gd2
 		gdimagearc
+		gdimageclone
 		gdimagecolorclosest
 		gdimagecolordeallocate
 		gdimagecolorexact
--- libgd2-jessie.git.orig/tests/Makefile.am
+++ libgd2-jessie.git/tests/Makefile.am
@@ -37,6 +37,7 @@
 	gd2/gd2_null \
 	gd2/gd2_read \
 	gdimagearc/bug00079 \
+	gdimageclone/style \
 	gdimageline/gdimageline_aa \
 	gdimageline/bug00072 \
 	gdimageline/bug00077 \
@@ -137,6 +138,7 @@
 check_PROGRAMS += \
 	gdimagestringft/gdimagestringft_bbox \
 	gdimagearc/bug00079 \
+	gdimageclone/style \
 	gdimageline/gdimageline_aa \
 	gdimageline/bug00072 \
 	gdimageline/bug00077 \
@@ -283,6 +285,7 @@
 	gd2/CMakeLists.txt \
 	gdimagesetpixel/CMakeLists.txt \
 	gdimagearc/CMakeLists.txt \
+	gdimageclone/CMakeLists.txt \
 	png/CMakeLists.txt \
 	gdimagestringftex/CMakeLists.txt \
 	gdimageline/CMakeLists.txt \
--- libgd2-jessie.git.orig/tests/Makefile.in
+++ libgd2-jessie.git/tests/Makefile.in
@@ -59,6 +59,7 @@
 	gdtiled/bug00032$(EXEEXT) gd2/gd2_im2im$(EXEEXT) \
 	gd2/gd2_null$(EXEEXT) gd2/gd2_read$(EXEEXT) \
 	gdimagearc/bug00079$(EXEEXT) \
+	gdimageclone/style$(EXEEXT) \
 	gdimageline/gdimageline_aa$(EXEEXT) \
 	gdimageline/bug00072$(EXEEXT) gdimageline/bug00077$(EXEEXT) \
 	gdimageline/bug00111$(EXEEXT) \
@@ -132,6 +133,7 @@
 @HAVE_LIBPNG_TRUE@am__append_6 = \
 @HAVE_LIBPNG_TRUE@	gdimagestringft/gdimagestringft_bbox \
 @HAVE_LIBPNG_TRUE@	gdimagearc/bug00079 \
+@HAVE_LIBPNG_TRUE@	gdimageclone/style \
 @HAVE_LIBPNG_TRUE@	gdimageline/gdimageline_aa \
 @HAVE_LIBPNG_TRUE@	gdimageline/bug00072 \
 @HAVE_LIBPNG_TRUE@	gdimageline/bug00077 \
@@ -226,6 +228,7 @@
 @HAVE_LIBPNG_TRUE@@HAVE_LIBZ_TRUE@	gdtiled/bug00032$(EXEEXT)
 @HAVE_LIBPNG_TRUE@am__EXEEXT_6 = gdimagestringft/gdimagestringft_bbox$(EXEEXT) \
 @HAVE_LIBPNG_TRUE@	gdimagearc/bug00079$(EXEEXT) \
+@HAVE_LIBPNG_TRUE@	gdimageclone/style$(EXEEXT) \
 @HAVE_LIBPNG_TRUE@	gdimageline/gdimageline_aa$(EXEEXT) \
 @HAVE_LIBPNG_TRUE@	gdimageline/bug00072$(EXEEXT) \
 @HAVE_LIBPNG_TRUE@	gdimageline/bug00077$(EXEEXT) \
@@ -321,6 +324,10 @@
 gdimagearc_bug00079_OBJECTS = bug00079.$(OBJEXT)
 gdimagearc_bug00079_LDADD = $(LDADD)
 gdimagearc_bug00079_DEPENDENCIES = ../src/libgd.la libgdtest.a
+gdimageclone_style_SOURCES = gdimageclone/style.c
+gdimageclone_style_OBJECTS = style.$(OBJEXT)
+gdimageclone_style_LDADD = $(LDADD)
+gdimageclone_style_DEPENDENCIES = ../src/libgd.la libgdtest.a
 gdimagecolorclosest_gdimagecolorclosest_SOURCES =  \
 	gdimagecolorclosest/gdimagecolorclosest.c
 gdimagecolorclosest_gdimagecolorclosest_OBJECTS =  \
@@ -748,6 +755,7 @@
 	freetype/bug00132.c gd/gd_im2im.c gd/gd_null.c \
 	gd/gd_num_colors.c gd2/gd2_empty_file.c gd2/gd2_im2im.c \
 	gd2/gd2_null.c gd2/gd2_read.c gdimagearc/bug00079.c \
+	gdimageclone/style.c \
 	gdimagecolorclosest/gdimagecolorclosest.c \
 	gdimagecolordeallocate/gdimagecolordeallocate.c \
 	gdimagecolorexact/gdimagecolorexact.c \
@@ -802,6 +810,7 @@
 	freetype/bug00132.c gd/gd_im2im.c gd/gd_null.c \
 	gd/gd_num_colors.c gd2/gd2_empty_file.c gd2/gd2_im2im.c \
 	gd2/gd2_null.c gd2/gd2_read.c gdimagearc/bug00079.c \
+	gdimageclone/style.c \
 	gdimagecolorclosest/gdimagecolorclosest.c \
 	gdimagecolordeallocate/gdimagecolordeallocate.c \
 	gdimagecolorexact/gdimagecolorexact.c \
@@ -1083,6 +1092,7 @@
 	gd2/CMakeLists.txt \
 	gdimagesetpixel/CMakeLists.txt \
 	gdimagearc/CMakeLists.txt \
+	gdimageclone/CMakeLists.txt \
 	png/CMakeLists.txt \
 	gdimagestringftex/CMakeLists.txt \
 	gdimageline/CMakeLists.txt \
@@ -1262,6 +1272,12 @@
 gdimagearc/bug00079$(EXEEXT): $(gdimagearc_bug00079_OBJECTS) $(gdimagearc_bug00079_DEPENDENCIES) gdimagearc/$(am__dirstamp)
 	@rm -f gdimagearc/bug00079$(EXEEXT)
 	$(LINK) $(gdimagearc_bug00079_OBJECTS) $(gdimagearc_bug00079_LDADD) $(LIBS)
+gdimageclone/$(am__dirstamp):
+	@$(MKDIR_P) gdimageclone
+	@: > gdimageclone/$(am__dirstamp)
+gdimageclone/style$(EXEEXT): $(gdimageclone_style_OBJECTS) $(gdimageclone_style_DEPENDENCIES) gdimageclone/$(am__dirstamp)
+	@rm -f gdimageclone/style$(EXEEXT)
+	$(LINK) $(gdimageclone_style_OBJECTS) $(gdimageclone_style_LDADD) $(LIBS)
 gdimagecolorclosest/$(am__dirstamp):
 	@$(MKDIR_P) gdimagecolorclosest
 	@: > gdimagecolorclosest/$(am__dirstamp)
@@ -1906,6 +1922,20 @@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
 @am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o bug00079.obj `if test -f 'gdimagearc/bug00079.c'; then $(CYGPATH_W) 'gdimagearc/bug00079.c'; else $(CYGPATH_W) '$(srcdir)/gdimagearc/bug00079.c'; fi`
 
+style.o: gdimageclone/style.c
+@am__fastdepCC_TRUE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT style.o -MD -MP -MF $(DEPDIR)/style.Tpo -c -o style.o `test -f 'gdimageclone/style.c' || echo '$(srcdir)/'`gdimageclone/style.c
+@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/style.Tpo $(DEPDIR)/style.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gdimageclone/style.c' object='style.o' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o style.o `test -f 'gdimageclone/style.c' || echo '$(srcdir)/'`gdimageclone/style.c
+
+style.obj: gdimageclone/style.c
+@am__fastdepCC_TRUE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT style.obj -MD -MP -MF $(DEPDIR)/style.Tpo -c -o style.obj `if test -f 'gdimageclone/style.c'; then $(CYGPATH_W) 'gdimageclone/style.c'; else $(CYGPATH_W) '$(srcdir)/gdimageclone/style.c'; fi`
+@am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/style.Tpo $(DEPDIR)/style.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gdimageclone/style.c' object='style.obj' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o style.obj `if test -f 'gdimageclone/style.c'; then $(CYGPATH_W) 'gdimageclone/style.c'; else $(CYGPATH_W) '$(srcdir)/gdimageclone/style.c'; fi`
+
 gdimagecolorclosest.o: gdimagecolorclosest/gdimagecolorclosest.c
 @am__fastdepCC_TRUE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT gdimagecolorclosest.o -MD -MP -MF $(DEPDIR)/gdimagecolorclosest.Tpo -c -o gdimagecolorclosest.o `test -f 'gdimagecolorclosest/gdimagecolorclosest.c' || echo '$(srcdir)/'`gdimagecolorclosest/gdimagecolorclosest.c
 @am__fastdepCC_TRUE@	$(am__mv) $(DEPDIR)/gdimagecolorclosest.Tpo $(DEPDIR)/gdimagecolorclosest.Po
@@ -3050,6 +3080,7 @@
 	-rm -rf gd/.libs gd/_libs
 	-rm -rf gd2/.libs gd2/_libs
 	-rm -rf gdimagearc/.libs gdimagearc/_libs
+	-rm -rf gdimageclone/.libs gdimageclone/_libs
 	-rm -rf gdimagecolorclosest/.libs gdimagecolorclosest/_libs
 	-rm -rf gdimagecolordeallocate/.libs gdimagecolordeallocate/_libs
 	-rm -rf gdimagecolorexact/.libs gdimagecolorexact/_libs
@@ -3290,6 +3321,7 @@
 	-rm -f gd/$(am__dirstamp)
 	-rm -f gd2/$(am__dirstamp)
 	-rm -f gdimagearc/$(am__dirstamp)
+	-rm -f gdimageclone/$(am__dirstamp)
 	-rm -f gdimagecolorclosest/$(am__dirstamp)
 	-rm -f gdimagecolordeallocate/$(am__dirstamp)
 	-rm -f gdimagecolorexact/$(am__dirstamp)
